<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

    <h2>Welcome, <span id="username"></span></h2>
    <button id="logout-btn">Logout</button>

    <h3>Create a Post</h3>
    <textarea id="post-text" placeholder="Write something..."></textarea>
    <button id="post-btn">Post</button>

    <h3>Posts</h3>
    <div id="post-feed"></div>

    <script>
        console.log("Initializing Firebase...");

        // Firebase Configuration
        const firebaseConfig = {
    apiKey: "AIzaSyClhEYEfda7mJJE8IuPmbG1T5zMM7Kh4_s",
    authDomain: "posting-53ee8.firebaseapp.com",
    projectId: "posting-53ee8",
    storageBucket: "posting-53ee8.firebasestorage.app",
    messagingSenderId: "304055644461",
    appId: "1:304055644461:web:a101285d086fcd399d23a4"
  };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log("Firebase Initialized");

        // Redirect if not logged in
        if (localStorage.getItem("loginState") !== "true") {
            console.warn("User not logged in. Redirecting...");
            window.location.href = "login.html";
        } else {
            document.getElementById("username").innerText = localStorage.getItem("userName");
            console.log("User logged in:", localStorage.getItem("userName"));
        }

        // Logout Function
        document.getElementById("logout-btn").addEventListener("click", () => {
            localStorage.removeItem("loginState");
            localStorage.removeItem("userName");
            window.location.href = "https://himamshus06.github.io/posts/";
        });

        // Post Message
        document.getElementById("post-btn").addEventListener("click", async () => {
            const postText = document.getElementById("post-text").value.trim();
            if (postText === "") {
                alert("Post cannot be empty");
                return;
            }

            try {
                await db.collection("posts").add({
                    username: localStorage.getItem("userName") || "Anonymous",
                    text: postText,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log("✅ Post added successfully!");
                document.getElementById("post-text").value = "";
            } catch (error) {
                console.error("❌ Firestore Error:", error.message);
                alert("Error posting: " + error.message);
            }
        });

        // Load Posts from Firestore
        function loadPosts() {
            console.log("Loading posts from Firestore...");
            
            db.collection("posts").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
                console.log("Received snapshot:", snapshot.docs.length, "documents");
                
                const postFeed = document.getElementById("post-feed");
                postFeed.innerHTML = ""; // Clear previous content

                snapshot.forEach((doc) => {
                    const post = doc.data();
                    const postId = doc.id;

                    postFeed.innerHTML += `
                        <div id="post-${postId}" style="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px;">
                            <strong>${post.username || "Unknown"}</strong>: ${post.text}
                            <br>
                            <small>Timestamp: ${post.timestamp?.toDate() || "No Timestamp"}</small>
                            <br>
                            <button onclick="replyToPost('${postId}')">Reply</button>
                            <div id="reply-section-${postId}"></div>
                            <div id="replies-${postId}" style="margin-left: 20px;"></div>
                        </div>
                    `;

                    loadReplies(postId); // Load replies dynamically
                });
            }, (error) => {
                console.error("❌ Error loading posts:", error.message);
                alert("Error loading posts: " + error.message);
            });
        }

        // Show reply input when "Reply" button is clicked
        function replyToPost(postId) {
            const replySection = document.getElementById(`reply-section-${postId}`);
            replySection.innerHTML = `
                <textarea id="reply-text-${postId}" placeholder="Write a reply..."></textarea>
                <button onclick="submitReply('${postId}')">Submit Reply</button>
            `;
        }

        // Submit reply to Firestore
        function submitReply(postId) {
            const replyText = document.getElementById(`reply-text-${postId}`).value.trim();
            if (replyText === "") {
                alert("Reply cannot be empty");
                return;
            }

            db.collection("posts").doc(postId).collection("replies").add({
                username: localStorage.getItem("userName") || "Anonymous",
                text: replyText,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                console.log("Reply added successfully!");
                document.getElementById(`reply-text-${postId}`).value = "";
                loadReplies(postId); // Refresh replies after submission
            }).catch((error) => {
                console.error("Error posting reply:", error);
            });
        }

        // Load Replies
        function loadReplies(postId) {
            console.log("Loading replies for post:", postId);
            db.collection("posts").doc(postId).collection("replies").orderBy("timestamp", "asc")
            .onSnapshot((snapshot) => {
                const replyDiv = document.getElementById(`replies-${postId}`);
                replyDiv.innerHTML = "";
                snapshot.forEach((doc) => {
                    const reply = doc.data();
                    console.log("Loaded Reply:", reply);
                    replyDiv.innerHTML += `<p><strong>${reply.username}</strong>: ${reply.text}</p>`;
                });
            }, (error) => {
                console.error("Error loading replies:", error);
            });
        }

        // Load posts on page load
        loadPosts();
    </script>

</body>
</html>
